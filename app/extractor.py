from typing import List, Dict
from .models import TranscriptSegmentIn, Protocol
from .normalization import (
    parse_height_cm, parse_weight_kg, parse_spo2,
    parse_bp_systolic, calc_bmi
)
from .llm import call_llm
import json

def build_protocol_from_segments(segments: List[TranscriptSegmentIn]) -> Dict:
    text_all = " ".join(s.text for s in segments)


    # ---------------------------
    # Вытаскиваем витальные данные
    # ---------------------------
    height = parse_height_cm(text_all)
    weight = parse_weight_kg(text_all)
    spo2 = parse_spo2(text_all)
    bp = parse_bp_systolic(text_all)
    bmi_val = calc_bmi(weight, height)

    # ---------------------------
    # Базовая структура протокола (новая)
    # ---------------------------
    protocol = {
        "exam_data": {
            "complaints": None,
            "anamnesis": None,
            "diagnosis": None,
            "treatment_plan": None,
            "patient_recommendations": None
        },
        "vitals": {
            "height_cm": height,
            "weight_kg": weight,
            "bmi": bmi_val,
            "waist_height_ratio": None,
            "pulse": None,
            "spo2": spo2,
            "systolic_bp": bp
        },
        "clinical_decision_support": {
            "quality_criteria": {
                "greeting_and_contact": [],
                "conversation_structure": [],
                "needs_identification": [],
                "current_complaints_identification": [],
                "disease_history": [],
                "general_medical_history": [],
                "medication_history": [],
                "family_history": [],
                "prevention_and_risk_control": [],
                "treatment_planning": [],
                "visit_closure": []
            },
            "examination_quality": {
                "overall_score": None,
                "criteria_completed": None,
                "criteria_total": None
            },
            "dialogue_analytics": []
        }
    }


    try:
        joined = "\n".join(f"{s.speaker}: {s.text}" for s in segments)
        prompt = """
# ЗАДАЧА
Проанализируй транскрипцию и выведи ЕДИНЫЙ валидный JSON-объект.

# GUARDRAILS
- ЗАПРЕТ ЦИТАТ (ДЛЯ БЛОКА 1): В блоке exam_data ты ОБЯЗАН интерпретировать слова (писать суть), а не цитировать. Если ты используешь прямую цитату — это провал.
- ЗАПРЕТ НА ПРЕДПОЛОЖЕНИЯ (ДЛЯ БЛОКА 3, 4): В блоках quality_criteria и dialogue_analytics оценка по умолчанию ВСЕГДА 0. Ты должен найти явное ДОКАЗАТЕЛЬСТВО в транскрипции, чтобы повысить балл. Если доказательства нет, балл ОСТАЕТСЯ 0.
- ЗАПРЕТ НА ОЦЕНКУ ПАЦИЕНТА: Оцениваются ТОЛЬКО ДЕЙСТВИЯ ВРАЧА. Если врач не поздоровался, а пациент поздоровался, балл greeting_and_contact = 0.

# exam_data
ИНСТРУКЦИЯ : Действуй как ассистент врача. Твоя задача — проанализировать реплики пациента и врача и сформулировать их как краткую медицинскую выжимку. Здесь ты ОБЯЗАН интерпретировать, а не цитировать. Используй профессиональную лексику. Если данных по полю нет, верни null
1. exam_data.complaints - жалобы пациента
2. exam_data.anamnesis - анамнез заболеваний и сопуствующие сведенья
3. exam_data.diagnosis - окончательный или предварительный диагноз
4. exam_data.treatment_plan - план лечения
5. exam_data.patient_recommendations - рекомендации пациенту

# Vitals
ИНСТРУКЦИЯ: Найди в транскрипции точные числовые показатели. Если показатель не упоминался, верни null. Вывод должен быть числом (number), а не строкой
1. vitals.height_cm - рост пациента в сантиметрах (преобразуй если приведено в метрах) 
2. vitals.weight_kg - вес пациента в килограмах
3. vitals.bmi - индекс массы тела (ИМТ) пациента
4. vitals.waist_height_ratio - индекс талии к росту пациента
5. vitals.pulse - пульс пациента
6. vitals.spo2 - сатурация пациента
7. vitals.systolic_bp - систолическое артериальное давление пациента

# quality_criteria
ИНСТРУКЦИЯ: Оценка по умолчанию 0. Повышай балл, только если ВРАЧ совершил действие
## greeting_and_contact
0: (По умолчанию) Нет явного приветствия, представления ИЛИ идентификации со стороны ВРАЧА
1: Врач поздоровался
2: Врач поздоровался и представился (назвал свои ФИО и/или должность)
3: Врач поздоровался, представился и уточнил данные о пациенте (ФИО пациента, паспортные данные пациента)
## conversation_structure
0: (По умолчанию) Структура отсутствует, диалог хаотичный
1: Присутствует 1 этап (только сбор жалоб)
2: Присутствует 2 этапа (сбор жалоб -> план лечения)
3: Присутствует 3 этапа (сбор жалоб -> анамнез -> план лечения)
4: Присутствуют все 4 этапа (Сбор жалоб -> Анамнез -> Диагноз/План -> Завершение)
## needs_identification
0: (По умолчанию) Врач не выявил потребности пациента
1: Врач выявил основную причину визита
2: Врач выявил причину визита и уточнил ожидания/беспокойства пациента (как вариант фразой "Что вас беспокоит больше всего?")
## current_complaints_identification
0: (По умолчанию) Врач не извлек из пациента инофрмаци о текущих жалобах
1: Врач использовал только закрытые вопросы (как пример "Здесь болит?")
2: Врач использовал открытые вопросы (как пример "Расскажите о своей боли")
3: Врач использовал открытые вопросы и уточнил детали жалобы (хронология, интенсивность, характер)
## disease_history
0: (По умолчанию) Врач не извлек из пациента анамнез текущего заболевания
1: Врач спросил, когда началось заболевание
2: Врач уточнил хронологию и динамику заболевания
3: Врач уточнил хронологию, динамику и предыдущее лечение/обследования по этому заболеванию
## general_medical_history
0: (По умолчанию) Врач не извлек из пациент информацию о истории заболеваний
1: Врач спросил только о наличии хронических заболеваний
2: Врач спросил о хронических заболеваниях и/или перенесенных операциях/госпитализациях
3: Врач спросил о хронических заболеваниях, операциях/госпитализациях И аллергиях
## medication_history
0: (По умолчанию) Врач не извлек из пациента информацию о истории применения лекарств
1: Врач спросил, принимает ли пациент какие-либо лекарства
2: Врач уточнил названия И/ИЛИ дозировки принимаемых лекарств
3: Врач уточнил названия, дозировки И выявил наличие\отсутствие лекарственной аллергии
## family_history
0: (По умолчанию) Врач не извлек из пациента информацию о семейных заболеваниях
1: Пациент сам упомянул семейный анамнез
2: Врач задал общий вопрос о здоровье родственников
3: Врач задал прицельные вопросы о наследственных заболеваниях (диабет, онкология, ССЗ, и т.п.)
## prevention_and_risk_control
0: (По умолчанию) Врач не извлек из пациента информацию по факторам риска 
1: Врач спросил хотя бы об одном факторе (курение, алкоголь, диета, физическая активность)
2: Врач спросил о нескольких факторах риска
3: Врач спросил о факторах риска И дал рекомендации по действиям в их отношении (как пример "Вам необходимо бросить курить")
## treatment_planning
0: (По умолчанию) Врач не озвучил план лечения
1: Врач озвучил план лечения (назначил препараты/процедуры)
2: Врач озвучил план И обосновал его (объяснил, зачем нужен препарат)
3: Врач озвучил план, обосновал его И уточнил у клиента понимание связанных с планом моментов (дозировки, причины, действия)
## visit_closure
0: (По умолчанию) Диалог оборвался или завершился без подведения итогов
1: Врач попрощался с пациентом
2: Врач кратко резюмировал итоги встречи ИЛИ назначил дату следующего визита
3: Врач резюмировал итоги, назначил следующий визит/шаги И дал пациенту возможность задать финальные вопросы

# dialogue_analytics
ИНСТРУКЦИЯ: 0 - нет, 1 - да/факт подтвержден
## doctor_showed_empathy
- 1, если врач вербально отреагировал на эмоции или дискомфорт пациента
- 0 - в остальных случаях
## doctor_interrupted_patient
- 1, если врач перебил пациента во время сбора жалоб или анамнеза (не дал закончить мысль)
## patient_asked_questions
- 1, если пациент задавал уточняющие вопросы о своем состоянии, диагнозе или лечении
## doctor_used_medical_jargon
- 1, если врач использовал сложные медицинские термины БЕЗ их объяснения пациенту
## doctor_confirmed_understanding
- 1, если врач в конце консультации явно спросил пациента, все ли ему понятно (как пример возможных вопросов "У вас остались вопросы?", "Вам понятен план лечения?")
## lifestyle_discussed
- 1, если обсуждались факторы риска (курение, алкоголь, диета, сон, стресс, физическая активность и т.п.)
## allergies_discussed
- 1, если в диалоге прозвучало слово "аллергия" (либо врач спросил, либо пациент сообщил)
## shared_decision_making
1, если врач предложил пациенту выбор из нескольких вариантов лечения (как пример "Мы можем пойти двумя путями...", "Что для вас предпочтительнее?")
## patient_compliance_assessment
1, если врач пытался оценить приверженность пациента лечению (как пример "Вам удается принимать таблетки каждый день?", "Что мешает соблюдать диету?")
## doctor_pacing
1, если врач явно управлял темпом беседы (как пример "Давайте вернемся к...", "У нас осталось 5 минут")

# ФОРМА ВЫВОДА
СТРОГОЕ ТРЕБОВАНИЕ: Твой ответ должен быть ТОЛЬКО валидным JSON-объектом. Следуй образцу максимально строго, без каких-либо отклонений, комментариев или текста до/после JSON. 
В ТВОЁМ ОТВЕТЕ НЕ ДОЛЖНО БЫТЬ MARKDOWN РАЗМЕТКИ ИЛИ ЛЮБЫХ НЕЗАПРОШЕННЫХ В ПРОМТЕ ИЗМЕНЕНИЙ, ТЫ ОБЯЗАН ВЫДАТЬ ИСКЛЮЧИТЕЛЬНО УКАЗАННОЕ В ФОРМЕ ВЫВОДА И БОЛЬШЕ НИЧЕГО
ТЫ НЕ ИМЕЕШЬ ПРАВА МОДИФИЦИРОВАТЬ ФОРМУ ВЫВОДА, СТРОГО СЛЕДУЙ ЕЁ СТРУКТУРЕ БЕЗ ВНЕСЕНИЯ ЛЮБЫХ ИЗМЕНЕНИЙ КРОМЕ ЗАПОЛНЕНИЯ ПЛЕСХОЛДЕРОВ
НЕ ДОБАВЛЯЙ ТРАНСКРИБАЦИЮ К СВОЕМУ ВЫВОДУ
ПРАВИЛО ВЫВОДА: <> - обозначение плейсхолдера, его не должно быть в выводимой тобой схеме, заполни их соответствующим контентом
{
    "exam_data": {                      // Данные медицинского осмотра
        "complaints": "<жалобы>",                 // Жалобы пациента
        "anamnesis": "<анамнез>",                  // Анамнез заболевания и сопутствующие сведения
        "diagnosis": "<диагноз>",                  // Предварительный или окончательный диагноз
        "treatment_plan": "<план лечения>",             // План лечения
        "patient_recommendations": "<рекомендации>"     // Рекомендации пациенту
  },
    "vitals": {
        "height_cm": <рост>,
        "weight_kg": <вес>,
        "bmi": <ИМТ>,
        "waist_height_ratio": <талия/рост>,
        "pulse": <пульс>,
        "spo2": <сатурация>,
        "systolic_bp": <систолическое арт. давление>
  },
    "quality_criteria": {             // Критерии качества консультации
        "greeting_and_contact": <0/3>,
        "conversation_structure": <0/4>,
        "needs_identification": <0/2>,
        "current_complaints_identification": <0/3>,
        "disease_history": <0/3>,
        "general_medical_history": <0/3>,
        "medication_history": <0/3>,
        "family_history": <0/3>,
        "prevention_and_risk_control": <0/3>,
        "treatment_planning": <0/3>,
        "visit_closure": <0/3>
    },
    "dialogue_analytics": {
        "doctor_showed_empathy": <0/1>,
        "doctor_interrupted_patient": <0/1>,
        "patient_asked_questions": <0/1>,
        "doctor_used_medical_jargon": <0/1>,
        "doctor_confirmed_understanding": <0/1>,
        "lifestyle_discussed": <0/1>,
        "allergies_discussed": <0/1>,
        "shared_decision_making" <0/1>,
        "patient_compliance_assessment" <0/1>,
        "doctor_pacing" <0/1>
    }
}

---

# Текст диалога
        """ + joined
        print(prompt)
        llm_out = call_llm(prompt)
        parsed = json.loads(llm_out)
        protocol.update({k: v for k, v in parsed.items() if k in protocol})
    except Exception:
        pass

    return protocol
