from typing import List, Dict
from .models import TranscriptSegmentIn, Protocol
from .normalization import (
    parse_height_cm, parse_weight_kg, parse_spo2,
    parse_bp_systolic, calc_bmi
)
from .llm import call_llm
import json

def build_protocol_from_segments(segments: List[TranscriptSegmentIn]) -> Dict:
    text_all = " ".join(s.text for s in segments)


    # ---------------------------
    # Вытаскиваем витальные данные
    # ---------------------------
    height = parse_height_cm(text_all)
    weight = parse_weight_kg(text_all)
    spo2 = parse_spo2(text_all)
    bp = parse_bp_systolic(text_all)
    bmi_val = calc_bmi(weight, height)

    # ---------------------------
    # Базовая структура протокола (новая)
    # ---------------------------
    protocol = {
        "exam_data": {
            "complaints": None,
            "anamnesis": None,
            "diagnosis": None,
            "treatment_plan": None,
            "patient_recommendations": None
        },
        "vitals": {
            "height_cm": height,
            "weight_kg": weight,
            "bmi": bmi_val,
            "waist_height_ratio": None,
            "pulse": None,
            "spo2": spo2,
            "systolic_bp": bp
        },
        "clinical_decision_support": {
            "quality_criteria": {
                "greeting_and_contact": [],
                "conversation_structure": [],
                "needs_identification": [],
                "current_complaints_identification": [],
                "disease_history": [],
                "general_medical_history": [],
                "medication_history": [],
                "family_history": [],
                "prevention_and_risk_control": [],
                "treatment_planning": [],
                "visit_closure": []
            },
            "examination_quality": {
                "overall_score": None,
                "criteria_completed": None,
                "criteria_total": None
            },
            "dialogue_analytics": []
        }
    }


    try:
        joined = "\n".join(f"{s.speaker}: {s.text}" for s in segments)
        prompt = f"""
# Задача
На основе полученной транскрибации напиши ответы по текстовым данным и критериям (согласно предоставленным образцам ответов) и выведи ЕДИНЫЙ валидный JSON-объект, в который будут помещены все ответы.
СТРОГОЕ ПРАВИЛО С НАИВЫСШИМ ПРИОРИТЕТОМ: Твои ответы должны основываться ИСКЛЮЧИТЕЛЬНО НА ПРЕДОСТАВЛЕННОЙ ТРАНСКРИБАЦИИ. Никаких домыслов, предположений или информации, не озвученной в тексте. Действуй строго по критериям и образцам выдачи.

# exam_data
## complaints
найди в транскрибации данные по жалобам со стороны пациента и помести их в exam_data.complaints
если данные есть "exam_data.complaints": [жалобы],
если данных нет "exam_data.complaints": null,

## anamnesis
найди в транскрибации данные по анамнезу заболеваний и сопуствующим сведениям и помести их в exam_data.anamnesis
если данные есть "exam_data.anamnesis": [анамнез],
если данных нет "exam_data.anamnesis": null,

## diagnosis
найди в транскрибации данные по окончательному или предварительному диагнозу и помести их в exam_data.diagnosis
если данные есть "exam_data.diagnosis": [предварительный \ окончательный диагноз]
если данных нет "exam_data.diagnosis": null,

## treatment_plan
найди в транскрибации данные по плану лечения и помести их в exam_data.treatment_plan
если данные есть "exam_data.treatment_plan": [план лечения],
если данных нет "exam_data.treatment_plan": null,

## patient_recommendations
найди в транскрибации данные по рекомендациям пациенту и помести их в exam_data.patient_recommendations
если данные есть "exam_data.patient_recommendations": [рекомендации пациенту],
если данных нет "exam_data.patient_recommendations": null,

# Vitals
## height_cm
если в транскрибации прозвучали данные о росте пациента помести их в vitals.height_cm
если данных нет "vitals.height_cm": null,

## weight_kg
если в транскрибации прозвучали данные о весе пациента помести их в vitals.weight_kg
если данных нет "vitals.weight_kg": null,

## bmi
если в транскрибации прозвучали данные о индексе массы тела (ИМТ) пациента помести их в vitals.bmi
если данных нет "vitals.bmi": null,

## waist_height_ratio
если в транскрибации прозвучали данные о индексе талии к росту пациента помести их в vitals.waist_height_ratio
если данных нет "vitals.waist_height_ratio": null,

## pulse
если в транскрибации прозвучали данные о пульсе пациента помести их в vitals.pulse
если данных нет "vitals.pulse": null,

## spo2
если в транскрибации прозвучали данные о сатурации пациента помести их в vitals.spo2
если данных нет "vitals.vitals.spo2": null,

## systolic_bp
если в транскрибации прозвучали данные о систолическом артериальном давлении пациента помести их в vitals.systolic_bp
если данных нет "vitals.systolic_bp": null,

# quality_criteria
на основе приведенных критериев ты должен выставить оценки по соответствующим пунктам в форме вывода

## greeting_and_contact
// Приветствие и установление контакта
0: Врач не поздоровался
1: Врач поздоровался с пациентом
2: Врач поздоровался и представился (назвал ФИО и/или должность)
3: Врач поздоровался, представился и уточнил данные о пациенте (идентификация пациента)

## conversation_structure
// Структура разговора
0: Структура отсутствует, диалог хаотичный
1: Присутствует 1 этап (только сбор жалоб)
2: Присутствует 2 этапа (сбор жалоб -> план лечения)
3: Присутствует 3 этапа (сбор жалоб -> анамнез -> план лечения)
4: Присутствуют все 4 этапа (Сбор жалоб -> Анамнез -> Диагноз/План -> Завершение)

## needs_identification
// Выявление потребностей пациента
0: Врач не выявил потребности пациента
1: Врач выявил основную причину визита
2: Врач выявил причину визита и уточнил ожидания/беспокойства пациента (как вариант фразой "Что вас беспокоит больше всего?")

## current_complaints_identification
// Выявление текущих жалоб
0: Врач не извлек из пациента инофрмаци о текущих жалобах
1: Врач использовал только закрытые вопросы (как пример "Здесь болит?")
2: Врач использовал открытые вопросы (как пример "Расскажите о своей боли")
3: Врач использовал открытые вопросы и уточнил детали жалобы (хронология, интенсивность, характер)

## disease_history
// Анамнез текущего заболевания
0: Врач не извлек из пациента анамнез текущего заболевания
1: Врач спросил, когда началось заболевание
2: Врач уточнил хронологию и динамику заболевания
3: Врач уточнил хронологию, динамику и предыдущее лечение/обследования по этому заболеванию

## general_medical_history
// Общий медицинский анамнез
0: Врач не извлек из пациент информацию о истории заболеваний
1: Врач спросил только о наличии хронических заболеваний
2: Врач спросил о хронических заболеваниях и/или перенесенных операциях/госпитализациях
3: Врач спросил о хронических заболеваниях, операциях/госпитализациях И аллергиях

## medication_history
// Лекарственный анамнез
0: Врач не извлек из пациента информацию о истории применения лекарств
1: Врач спросил, принимает ли пациент какие-либо лекарства
2: Врач уточнил названия И/ИЛИ дозировки принимаемых лекарств
3: Врач уточнил названия, дозировки И выявил наличие\отсутствие лекарственной аллергии

## family_history
// Семейный анамнез
0: Врач не извлек из пациента информацию о семейных заболеваниях
1: Пациент сам упомянул семейный анамнез
2: Врач задал общий вопрос о здоровье родственников
3: Врач задал прицельные вопросы о наследственных заболеваниях (диабет, онкология, ССЗ, и т.п.)

## prevention_and_risk_control
// Профилактика и контроль факторов риска
0: Врач не извлек из пациента информацию по факторам риска 
1: Врач спросил хотя бы об одном факторе (курение, алкоголь, диета, физическая активность)
2: Врач спросил о нескольких факторах риска
3: Врач спросил о факторах риска И дал рекомендации по действиям в их отношении (как пример "Вам необходимо бросить курить")

## treatment_planning
// Планирование лечения
0: Врач не озвучил план лечения
1: Врач озвучил план лечения (назначил препараты/процедуры)
2: Врач озвучил план И обосновал его (объяснил, зачем нужен препарат)
3: Врач озвучил план, обосновал его И уточнил у клиента понимание связанных с планом моментов (дозировки, причины, действия)

## visit_closure
// Заключение визита
0: Диалог оборвался или завершился без подведения итогов
1: Врач попрощался с пациентом
2: Врач кратко резюмировал итоги встречи ИЛИ назначил дату следующего визита
3: Врач резюмировал итоги, назначил следующий визит/шаги И дал пациенту возможность задать финальные вопросы

# dialogue_analytics
// аналитические метки 
## doctor_showed_empathy
- 1, если врач вербально отреагировал на эмоции или дискомфорт пациента
- 0 - в остальных случаях

## doctor_interrupted_patient
- 1, если врач перебил пациента во время сбора жалоб или анамнеза (не дал закончить мысль)

## patient_asked_questions
- 1, если пациент задавал уточняющие вопросы о своем состоянии, диагнозе или лечении

## doctor_used_medical_jargon
- 1, если врач использовал сложные медицинские термины БЕЗ их объяснения пациенту

## doctor_confirmed_understanding
- 1, если врач в конце консультации явно спросил пациента, все ли ему понятно (как пример возможных вопросов "У вас остались вопросы?", "Вам понятен план лечения?")

## lifestyle_discussed
- 1, если обсуждались факторы риска (курение, алкоголь, диета, сон, стресс, физическая активность и т.п.)

## allergies_discussed
- 1, если в диалоге прозвучало слово "аллергия" (либо врач спросил, либо пациент сообщил)

# Форма вывода
СТРОГОЕ ТРЕБОВАНИЕ: Твой ответ должен быть ТОЛЬКО валидным JSON-объектом. Следуй образцу максимально строго, без каких-либо отклонений, комментариев или текста до/после JSON.
{{
    "exam_data": {{                      // Данные медицинского осмотра
        "complaints": "[жалобы]",                 // Жалобы пациента
        "anamnesis": "[анамнез]",                  // Анамнез заболевания и сопутствующие сведения
        "diagnosis": "[диагноз]",                  // Предварительный или окончательный диагноз
        "treatment_plan": "[план лечения]",             // План лечения
        "patient_recommendations": "[рекомендации]"     // Рекомендации пациенту
  }},
    "vitals": {{
        "height_cm": [рост],
        "weight_kg": [вес],
        "bmi": [ИМТ],
        "waist_height_ratio": [талия/рост],
        "pulse": [пульс],
        "spo2": [сатурация],
        "systolic_bp": [систолическое арт. давление]
  }},
    "quality_criteria": {{             // Критерии качества консультации
        "greeting_and_contact": <0/3>,
        "conversation_structure": <0/4>,
        "needs_identification": <0/2>,
        "current_complaints_identification": <0/3>,
        "disease_history": <0/3>,
        "general_medical_history": <0/3>,
        "medication_history": <0/3>,
        "family_history": <0/3>,
        "prevention_and_risk_control": <0/3>,
        "treatment_planning": <0/3>,
        "visit_closure": <0/3>
    }},
    "dialogue_analytics": {{
        "doctor_showed_empathy": <0/1>,
        "doctor_interrupted_patient": <0/1>,
        "patient_asked_questions": <0/1>,
        "doctor_used_medical_jargon": <0/1>,
        "doctor_confirmed_understanding": <0/1>,
        "lifestyle_discussed": <0/1>,
        "allergies_discussed": <0/1>,
    }}
}}

# Транскрибация
{joined}
        """
        llm_out = call_llm(prompt)
        print(prompt)
        parsed = json.loads(llm_out)
        print(json.dumps(parsed))
        protocol.update({k: v for k, v in parsed.items() if k in protocol})
    except Exception:
        pass

    return protocol
